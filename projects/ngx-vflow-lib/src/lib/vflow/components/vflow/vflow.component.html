<svg:svg
  rootSvgRef
  rootSvgContext
  rootPointer
  flowSizeController
  class="root-svg"
  #flow
>
  <defs [markers]="markers()" flowDefs />

  <g background />

  <svg:g mapContext spacePointContext>
    <!-- Connection -->
    <svg:g
      connection
      [model]="connection"
      [template]="connectionTemplateDirective()?.templateRef"
    />

    @if (optimization().detachedGroupsLayer) {
      <!-- Groups -->
      @for (model of groups(); track trackNodes($index, model)) {
        <svg:g
          node
          [nodeModel]="model"
          [groupNodeTemplate]="groupNodeTemplateDirective()?.templateRef"
          [attr.transform]="model.pointTransform()"
        />
      }
      <!-- Edges  -->
      @for (model of edgeModels(); track trackEdges($index, model)) {
        <svg:g
          edge
          [model]="model"
          [edgeTemplate]="edgeTemplateDirective()?.templateRef"
          [edgeLabelHtmlTemplate]="edgeLabelHtmlDirective()?.templateRef"
        />
      }
      <!-- Nodes -->
      @for (model of nonGroups(); track trackNodes($index, model)) {
        <svg:g
          node
          [nodeModel]="model"
          [nodeTemplate]="nodeTemplateDirective()?.templateRef"
          [attr.transform]="model.pointTransform()"
        />
      }
    }

    @if (!optimization().detachedGroupsLayer) {
      <!-- Edges  -->
      @for (model of edgeModels(); track trackEdges($index, model)) {
        <svg:g
          edge
          [model]="model"
          [edgeTemplate]="edgeTemplateDirective()?.templateRef"
          [edgeLabelHtmlTemplate]="edgeLabelHtmlDirective()?.templateRef"
        />
      }
      <!-- Nodes -->
      @for (model of nodeModels(); track trackNodes($index, model)) {
        <svg:g
          node
          [nodeModel]="model"
          [nodeTemplate]="nodeTemplateDirective()?.templateRef"
          [groupNodeTemplate]="groupNodeTemplateDirective()?.templateRef"
          [attr.transform]="model.pointTransform()"
        />
      }
    }
  </svg:g>

  <!-- Minimap -->
  @if (minimap(); as minimap) {
    <ng-container [ngTemplateOutlet]="minimap.template()" />
  }
</svg:svg>
