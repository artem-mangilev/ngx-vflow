import{$c as I,Ba as H,Bb as E,Ca as x,Db as z,Ea as D,F as b,Ha as C,Ja as a,Ka as k,Ma as c,Zc as d,aa as w,c as v,ca as S,cd as R,ed as A,fd as u,g as l,ia as o,m as g,oa as r,p as Y,sa as O,w as p}from"./chunk-DTM2CGFO.js";var j=(()=>{class t{constructor(){this._event$=new l,this.event$=this._event$.asObservable()}pushEvent(i){this._event$.next(i)}static{this.\u0275fac=function(e){return new(e||t)}}static{this.\u0275prov=o({token:t,factory:t.\u0275fac})}}return t})();var F=(()=>{class t{constructor(){this.model=c(null)}static{this.\u0275fac=function(e){return new(e||t)}}static{this.\u0275prov=o({token:t,factory:t.\u0275fac})}}return t})();var it=(()=>{class t{constructor(){this.eventBus=r(j),this.nodeService=r(F),this.node=a.required(),this.selected=this.nodeService.model().selected,this.data=I(()=>this.node().data?.()),A(this.node).pipe(w(()=>this.trackEvents()),R()).subscribe()}ngOnInit(){}trackEvents(){let i=Object.getOwnPropertyNames(this),e=new Map;for(let s of i){let n=this[s];n instanceof D&&e.set(n,s),n instanceof C&&e.set($(n),s)}return b(...Array.from(e.keys()).map(s=>s.pipe(S(n=>{this.eventBus.pushEvent({nodeId:this.nodeService.model()?.rawNode.id??"",eventName:e.get(s),eventPayload:n})}))))}static{this.\u0275fac=function(e){return new(e||t)}}static{this.\u0275dir=z({type:t,inputs:{node:[1,"node"]}})}}return t})();function $(t){return new v(h=>{let i=t.subscribe(e=>{h.next(e)});return()=>{i.unsubscribe()}})}Y();function M(t,h,i){let e=i.value;return i.value=function(...s){queueMicrotask(()=>{e?.apply(this,s)})},i}var B=(()=>{class t{constructor(){this.node=c(null)}createHandle(i){let e=this.node();e&&e.handles.update(s=>[...s,i])}destroyHandle(i){let e=this.node();e&&e.handles.update(s=>s.filter(n=>n!==i))}static{this.\u0275fac=function(e){return new(e||t)}}static{this.\u0275prov=o({token:t,factory:t.\u0275fac})}}return g([M],t.prototype,"createHandle",null),t})();var m=class{constructor(h,i,e){this.rawHandle=h,this.parentNode=i,this.batchingService=e,this.strokeWidth=2,this.size=c({width:10+2*this.strokeWidth,height:10+2*this.strokeWidth}),this.pointAbsolute=d(()=>({x:this.parentNode.globalPoint().x+this.hostOffset().x+this.sizeOffset().x,y:this.parentNode.globalPoint().y+this.hostOffset().y+this.sizeOffset().y})),this.state=c("idle"),this.updateHostSizeAndPosition$=new l,this.hostSize=u(this.updateHostSizeAndPosition$.pipe(p(()=>this.getHostSize())),{initialValue:{width:0,height:0}}),this.hostPosition=u(this.updateHostSizeAndPosition$.pipe(p(()=>{let s=this.hostReference instanceof HTMLElement?this.batchingService.getElementOffsets(this.hostReference):void 0;return{x:s?s.offsetLeft:0,y:s?s.offsetTop:0}})),{initialValue:{x:0,y:0}}),this.hostOffset=d(()=>{switch(this.rawHandle.position){case"left":return{x:-this.rawHandle.userOffsetX,y:-this.rawHandle.userOffsetY+this.hostPosition().y+this.hostSize().height/2};case"right":return{x:-this.rawHandle.userOffsetX+this.parentNode.size().width,y:-this.rawHandle.userOffsetY+this.hostPosition().y+this.hostSize().height/2};case"top":return{x:-this.rawHandle.userOffsetX+this.hostPosition().x+this.hostSize().width/2,y:-this.rawHandle.userOffsetY};case"bottom":return{x:-this.rawHandle.userOffsetX+this.hostPosition().x+this.hostSize().width/2,y:-this.rawHandle.userOffsetY+this.parentNode.size().height}}}),this.sizeOffset=d(()=>{switch(this.rawHandle.position){case"left":return{x:-(this.size().width/2),y:0};case"right":return{x:this.size().width/2,y:0};case"top":return{x:0,y:-(this.size().height/2)};case"bottom":return{x:0,y:this.size().height/2}}}),this.hostReference=this.rawHandle.hostReference,this.template=this.rawHandle.template,this.templateContext={$implicit:{point:this.hostOffset,state:this.state,node:this.parentNode.rawNode}},this.hostReference instanceof HTMLElement&&this.batchingService.addElementCache(this.hostReference)}onDestroy(){this.hostReference instanceof HTMLElement&&this.batchingService.removeElementCache(this.hostReference)}updateHost(){this.batchingService.markCacheAsDirty(),this.updateHostSizeAndPosition$.next()}getHostSize(){if(this.hostReference instanceof HTMLElement){let h=this.batchingService.getElementOffsets(this.hostReference);if(h)return{width:h.offsetWidth,height:h.offsetHeight}}else if(this.hostReference instanceof SVGGraphicsElement)return this.hostReference.getBBox();return{width:0,height:0}}};var P=(()=>{class t{constructor(){this.elementOffsetCache=new Map,this.cacheIsDirty=!0,this.minMsBetweenDirty=16,this.lastDirty=void 0}addElementCache(i){this.elementOffsetCache.set(i,void 0),this.markCacheAsDirty()}removeElementCache(i){this.elementOffsetCache.delete(i)}getElementOffsets(i){let e,s=this.elementOffsetCache.get(i);if(s===void 0?this.addElementCache(i):e=s,this.cacheIsDirty){for(let{[0]:n}of this.elementOffsetCache){let q=n.offsetWidth,T=n.offsetHeight,L=n.offsetLeft,X=n.offsetTop,y={offsetWidth:q,offsetHeight:T,offsetLeft:L,offsetTop:X};this.elementOffsetCache.set(n,y),n===i&&(e=y)}this.cacheIsDirty=!1}return e}markCacheAsDirty(){let i=new Date;if(this.lastDirty===void 0){this.cacheIsDirty=!0,this.lastDirty=i;return}i.getTime()-this.lastDirty?.getTime()>this.minMsBetweenDirty&&(this.cacheIsDirty=!0,this.lastDirty=i)}static{this.\u0275fac=function(e){return new(e||t)}}static{this.\u0275prov=o({token:t,factory:t.\u0275fac})}}return t})();var N=(()=>{class t{constructor(){this.callbacks=[],this.requestAnimationFrameStarted=!1}batchAnimationFrame(i){this.callbacks.push(i),this.requestAnimationFrameStarted||(this.requestAnimationFrameStarted=!0,requestAnimationFrame(()=>{this.callbacks.map(e=>{e&&e()}),this.callbacks=[],this.requestAnimationFrameStarted=!1}))}static{this.\u0275fac=function(e){return new(e||t)}}static{this.\u0275prov=o({token:t,factory:t.\u0275fac})}}return t})();var Ht=(()=>{class t{constructor(){this.injector=r(H),this.handleService=r(B),this.element=r(k).nativeElement,this.destroyRef=r(x),this.requestAnimationFrameBatchingService=r(N),this.offsetBatchingCacheService=r(P),this.position=a.required(),this.type=a.required(),this.id=a(),this.template=a(),this.offsetX=a(0),this.offsetY=a(0)}ngOnInit(){O(this.injector,()=>{let i=this.handleService.node();if(i){let e=new m({position:this.position(),type:this.type(),id:this.id(),hostReference:this.element.parentElement,template:this.template(),userOffsetX:this.offsetX(),userOffsetY:this.offsetY()},i,this.offsetBatchingCacheService);this.handleService.createHandle(e),this.requestAnimationFrameBatchingService.batchAnimationFrame(()=>{e.updateHost()}),this.destroyRef.onDestroy(()=>{this.handleService.destroyHandle(e),e.onDestroy()})}})}static{this.\u0275fac=function(e){return new(e||t)}}static{this.\u0275cmp=E({type:t,selectors:[["handle"]],inputs:{position:[1,"position"],type:[1,"type"],id:[1,"id"],template:[1,"template"],offsetX:[1,"offsetX"],offsetY:[1,"offsetY"]},decls:0,vars:0,template:function(e,s){},encapsulation:2,changeDetection:0})}}return t})();export{j as a,F as b,it as c,M as d,B as e,P as f,N as g,Ht as h};
