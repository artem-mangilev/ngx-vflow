import{$c as A,Ba as D,Bb as I,Ca as H,Db as F,E,Ea as x,Ha as O,Ja as h,Ka as R,Ma as c,Zc as d,aa as w,c as g,ca as b,cd as j,ed as k,f as l,fd as S,ia as a,oa as o,sa as C,v,za as p}from"./chunk-75CTPCD6.js";var M=(()=>{class e{constructor(){this._event$=new l,this.event$=this._event$.asObservable()}pushEvent(t){this._event$.next(t)}static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275prov=a({token:e,factory:e.\u0275fac})}}return e})();var z=(()=>{class e{constructor(){this.model=c(null)}static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275prov=a({token:e,factory:e.\u0275fac})}}return e})();var ee=(()=>{class e{constructor(){this.eventBus=o(M),this.nodeService=o(z),this.node=h.required(),this.selected=this.nodeService.model().selected,this.data=A(()=>this.node().data?.()),k(this.node).pipe(w(()=>this.trackEvents()),j()).subscribe()}ngOnInit(){}trackEvents(){let t=Object.getOwnPropertyNames(this),i=new Map;for(let r of t){let n=this[r];n instanceof x&&i.set(n,r),n instanceof O&&i.set(T(n),r)}return E(...Array.from(i.keys()).map(r=>r.pipe(b(n=>{this.eventBus.pushEvent({nodeId:this.nodeService.model()?.rawNode.id??"",eventName:i.get(r),eventPayload:n})}))))}static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275dir=F({type:e,inputs:{node:[1,"node"]}})}}return e})();function T(e){return new g(s=>{let t=e.subscribe(i=>{s.next(i)});return()=>{t.unsubscribe()}})}var u=(()=>{class e{constructor(){this.callbacks=[],this.requestAnimationFrameStarted=!1}batchAnimationFrame(t){this.callbacks.push(t),this.requestAnimationFrameStarted||(this.requestAnimationFrameStarted=!0,requestAnimationFrame(()=>{this.callbacks.map(i=>{i&&i()}),this.callbacks=[],this.requestAnimationFrameStarted=!1}))}static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275prov=a({token:e,factory:e.\u0275fac})}}return e})();var G=(()=>{class e{constructor(){this.afService=o(u),this.node=c(null)}createHandle(t){this.afService.batchAnimationFrame(()=>{let i=this.node();i&&i.handles.update(r=>[...r,t])})}destroyHandle(t){let i=this.node();i&&i.handles.update(r=>r.filter(n=>n!==t))}static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275prov=a({token:e,factory:e.\u0275fac})}}return e})();var y=class{constructor(s,t,i,r){this.rawHandle=s,this.parentNode=t,this.htmlElementCacheService=i,this.svgGraphicElementCacheService=r,this.strokeWidth=2,this.size=c({width:10+2*this.strokeWidth,height:10+2*this.strokeWidth}),this.pointAbsolute=d(()=>({x:this.parentNode.globalPoint().x+this.hostOffset().x+this.sizeOffset().x,y:this.parentNode.globalPoint().y+this.hostOffset().y+this.sizeOffset().y})),this.state=c("idle"),this.updateHostSizeAndPosition$=new l,this.hostSize=S(this.updateHostSizeAndPosition$.pipe(v(()=>this.getHostSize())),{initialValue:{width:0,height:0}}),this.hostPosition=S(this.updateHostSizeAndPosition$.pipe(v(()=>{let n=this.hostReference instanceof HTMLElement?this.htmlElementCacheService.getElementData(this.hostReference):void 0;return{x:n?n.offsetLeft:0,y:n?n.offsetTop:0}})),{initialValue:{x:0,y:0}}),this.hostOffset=d(()=>{switch(this.rawHandle.position){case"left":return{x:-this.rawHandle.userOffsetX,y:-this.rawHandle.userOffsetY+this.hostPosition().y+this.hostSize().height/2};case"right":return{x:-this.rawHandle.userOffsetX+this.parentNode.width(),y:-this.rawHandle.userOffsetY+this.hostPosition().y+this.hostSize().height/2};case"top":return{x:-this.rawHandle.userOffsetX+this.hostPosition().x+this.hostSize().width/2,y:-this.rawHandle.userOffsetY};case"bottom":return{x:-this.rawHandle.userOffsetX+this.hostPosition().x+this.hostSize().width/2,y:-this.rawHandle.userOffsetY+this.parentNode.height()}}}),this.sizeOffset=d(()=>{switch(this.rawHandle.position){case"left":return{x:-(this.size().width/2),y:0};case"right":return{x:this.size().width/2,y:0};case"top":return{x:0,y:-(this.size().height/2)};case"bottom":return{x:0,y:this.size().height/2}}}),this.hostReference=this.rawHandle.hostReference,this.template=this.rawHandle.template,this.templateContext={$implicit:{point:this.hostOffset,state:this.state,node:this.parentNode.rawNode}},this.hostReference instanceof HTMLElement?this.htmlElementCacheService.addElementCache(this.hostReference):this.hostReference instanceof SVGGraphicsElement&&this.svgGraphicElementCacheService.addElementCache(this.hostReference)}onDestroy(){this.hostReference instanceof HTMLElement?this.htmlElementCacheService.removeElementCache(this.hostReference):this.hostReference instanceof SVGGraphicsElement&&this.svgGraphicElementCacheService.removeElementCache(this.hostReference)}updateHost(){this.htmlElementCacheService.markCacheAsDirty(),this.svgGraphicElementCacheService.markCacheAsDirty(),this.updateHostSizeAndPosition$.next()}getHostSize(){if(this.hostReference instanceof HTMLElement){let s=this.htmlElementCacheService.getElementData(this.hostReference);if(s)return{width:s.offsetWidth,height:s.offsetHeight}}else if(this.hostReference instanceof SVGGraphicsElement)return this.svgGraphicElementCacheService.getElementData(this.hostReference);return{width:0,height:0}}};var m=class{constructor(){this.cacheMap=new Map,this.cacheIsDirty=!0,this.minMsBetweenDirty=16,this.lastDirty=void 0}addElementCache(s){this.cacheMap.set(s,void 0),this.markCacheAsDirty()}removeElementCache(s){this.cacheMap.delete(s)}getElementData(s){let t=this.cacheMap.get(s);if(t===void 0&&(this.cacheMap.set(s,void 0),this.cacheIsDirty=!0),this.cacheIsDirty&&(this.refreshCache(),this.cacheIsDirty=!1),t=this.cacheMap.get(s),t===void 0)throw new Error("Unexpected cache entry undefied. We should never get here");return t}markCacheAsDirty(){let s=new Date;if(this.lastDirty===void 0){this.cacheIsDirty=!0,this.lastDirty=s;return}s.getTime()-this.lastDirty?.getTime()>this.minMsBetweenDirty&&(this.cacheIsDirty=!0,this.lastDirty=s)}};var B=(()=>{class e extends m{refreshCache(){for(let{[0]:t}of this.cacheMap){let i=t.offsetWidth,r=t.offsetHeight,n=t.offsetLeft,q=t.offsetTop,N={offsetWidth:i,offsetHeight:r,offsetLeft:n,offsetTop:q};this.cacheMap.set(t,N)}}static{this.\u0275fac=(()=>{let t;return function(r){return(t||(t=p(e)))(r||e)}})()}static{this.\u0275prov=a({token:e,factory:e.\u0275fac})}}return e})();var P=(()=>{class e extends m{refreshCache(){for(let{[0]:t}of this.cacheMap){let i=t.getBBox();this.cacheMap.set(t,i)}}static{this.\u0275fac=(()=>{let t;return function(r){return(t||(t=p(e)))(r||e)}})()}static{this.\u0275prov=a({token:e,factory:e.\u0275fac})}}return e})();var He=(()=>{class e{constructor(){this.injector=o(D),this.handleService=o(G),this.element=o(R).nativeElement,this.destroyRef=o(H),this.requestAnimationFrameBatchingService=o(u),this.htmlElementCacheService=o(B),this.svgGraphicElementCacheService=o(P),this.position=h.required(),this.type=h.required(),this.id=h(),this.template=h(),this.offsetX=h(0),this.offsetY=h(0)}ngOnInit(){C(this.injector,()=>{let t=this.handleService.node();if(t){let i=new y({position:this.position(),type:this.type(),id:this.id(),hostReference:this.element.parentElement,template:this.template(),userOffsetX:this.offsetX(),userOffsetY:this.offsetY()},t,this.htmlElementCacheService,this.svgGraphicElementCacheService);this.handleService.createHandle(i),this.requestAnimationFrameBatchingService.batchAnimationFrame(()=>{i.updateHost()}),this.destroyRef.onDestroy(()=>{this.handleService.destroyHandle(i),i.onDestroy()})}})}static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275cmp=I({type:e,selectors:[["handle"]],inputs:{position:[1,"position"],type:[1,"type"],id:[1,"id"],template:[1,"template"],offsetX:[1,"offsetX"],offsetY:[1,"offsetY"]},decls:0,vars:0,template:function(i,r){},encapsulation:2,changeDetection:0})}}return e})();export{M as a,z as b,ee as c,u as d,m as e,G as f,P as g,B as h,He as i};
